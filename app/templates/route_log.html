{% extends "base.html" %}

{% block title %}Route Log{% endblock %}

{% block css %}
<style>
    .search-container {
        margin-bottom: 20px;
    }

    .button-container {
        margin-bottom: 15px;
    }

    /* Route table styling */
    #route-table th:nth-child(1),
    #route-table td:nth-child(1) {
        width: 50px;
    }

    #route-table th:nth-child(2),
    #route-table td:nth-child(2) {
        width: 65%;
    }

    #route-table th:nth-child(3),
    #route-table td:nth-child(3) {
        width: 35%;
    }

    #route-table td:nth-child(2),
    #route-table td:nth-child(3) {
        white-space: nowrap;
        overflow-x: auto;
        max-width: 0;
        text-overflow: ellipsis;
        padding-bottom: 12px;
    }

    #route-table td::-webkit-scrollbar {
        height: 8px;
    }

    #route-table td::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    #route-table td::-webkit-scrollbar-thumb {
        background: #2185d0;
        border-radius: 4px;
    }

    #route-table td::-webkit-scrollbar-thumb:hover {
        background: #1678c2;
    }

    #route-table {
        margin-top: 10px;
    }

    .mapping-form {
        margin-bottom: 20px;
    }

    #route-table {
        max-width: 100%;
        width: 100%;
        table-layout: fixed;
    }
    /* END OF Route table styling */
</style>
{% endblock %}

{% block content %}
<h1 class="ui header page_header">Route Log</h1>
<div class="ui divider"></div>

<!-- Search Bar -->
<div class="search-container">
    <div class="ui fluid icon input">
        <input type="text" id="route-search" placeholder="Search endpoints...">
        <i class="search icon"></i>
    </div>
</div>

<!-- Map Button -->
<div class="button-container">
    <button class="ui primary button" id="map-button" disabled>
        Map Selected Endpoints
    </button>
</div>

<!-- Route Table -->
<table class="ui celled table" id="route-table">
    <thead>
        <tr>
            <th class="collapsing">
                <div class="ui checkbox">
                    <input type="checkbox" id="select-all">
                    <label></label>
                </div>
            </th>
            <th>Full Route</th>
            <th>Endpoint</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Mapping Modal -->
<div class="ui modal" id="mapping-modal">
    <i class="close icon"></i>
    <div class="header">
        Code Mapping Configuration
    </div>
    <div class="content">
        <div class="ui segment">
            <h4 class="ui header">Selected Endpoints</h4>
            <div class="ui ordered list" id="selected-endpoints-list">
            </div>
        </div>

        <div class="ui form mapping-form">
            <div class="field">
                <label>Framework</label>
                <div class="ui selection dropdown" id="framework-dropdown">
                    <input type="hidden" name="framework">
                    <i class="dropdown icon"></i>
                    <div class="default text">Select Framework</div>
                    <div class="menu">
                        <div class="item" data-value="flask">Flask</div>
                        <div class="item" data-value="laravel">Laravel</div>
                    </div>
                </div>
            </div>

            <div class="field">
                <label>Application Root Path</label>
                <input type="text" id="app-path" placeholder="/path/to/your/application">
            </div>
        </div>
    </div>
    <div class="actions">
        <div class="ui black deny button">
            Cancel
        </div>
        <div class="ui positive button" id="begin-mapping" disabled>
            Begin Mapping
        </div>
    </div>
</div>

<script type="text/javascript">
    const routeData = {};

    async function pollLogs() {
        try {
            const response = await fetch('/proxy/stream-logs');
            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";

            while (true) {
                const {
                    done,
                    value
                } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, {
                    stream: true
                });
                const lines = buffer.split("\n");
                buffer = lines.pop();

                lines.forEach(rawLine => {
                    const line = rawLine.startsWith("data: ") ?
                        rawLine.substring(6).trim() : rawLine.trim();
                    if (line) {
                        onLogLine(line);
                    }
                });
            }
        } catch (err) {
            console.error("Error polling logs:", err);
        }
    }

    function onLogLine(line) {
        try {
            const logEntry = JSON.parse(line);
            routeData[logEntry.route] = logEntry;
            renderTable();
        } catch (e) {
            console.error("Failed to parse log line as JSON:", line);
        }
    }

    function renderTable(searchTerm = '') {
        const tbody = document.querySelector('#route-table tbody');
        tbody.innerHTML = '';

        Object.values(routeData)
            .filter(entry => entry.route.toLowerCase().includes(searchTerm.toLowerCase()))
            .forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="collapsing">
                        <div class="ui checkbox">
                            <input type="checkbox" class="route-checkbox">
                            <label></label>
                        </div>
                    </td>
                    <td>${entry.route}</td>
                    <td>${entry.endpoint}</td>
                `;
                tbody.appendChild(row);
            });

        $('.ui.checkbox').checkbox();
        updateMapButton();
    }

    function updateBeginMappingButton() {
        const framework = $('#framework-dropdown').dropdown('get value');
        const appPath = $('#app-path').val().trim();
        const hasEndpoints = $('#selected-endpoints-list .item').length > 0;

        $('#begin-mapping').prop('disabled', !(framework && appPath && hasEndpoints));
    }

    function updateSelectedEndpointsList() {
        const list = $('#selected-endpoints-list');
        list.empty();

        $('.route-checkbox:checked').each(function() {
            const endpoint = $(this).closest('tr').find('td:eq(2)').text();
            list.append(`<div class="item">${endpoint}</div>`);
        });
    }

    // Initialize event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Semantic UI components
        $('.ui.dropdown').dropdown();

        // Search functionality
        $('#route-search').on('input', function(e) {
            renderTable(e.target.value);
        });

        // Select all checkbox
        $('#select-all').on('change', function() {
            const isChecked = this.checked;
            $('.route-checkbox').each(function() {
                $(this).prop('checked', isChecked);
            });
            updateMapButton();
        });

        // Map button click handler
        $('#map-button').on('click', function() {
            updateSelectedEndpointsList();
            $('#mapping-modal').modal('show');
        });

        // Framework dropdown and app path input handlers
        $('#framework-dropdown').dropdown({
            onChange: updateBeginMappingButton
        });

        $('#app-path').on('input', updateBeginMappingButton);


        // Begin mapping button handler
        $('#begin-mapping').on('click', async function() {
            const selectedEndpoints = [];

            // Get endpoints from the modal's list
            $('#selected-endpoints-list .item').each(function() {
                selectedEndpoints.push($(this).text());
            });

            const mappingData = {
                framework: $('#framework-dropdown').dropdown('get value'),
                app_path: $('#app-path').val().trim(),
                endpoints: selectedEndpoints
            };

            console.log('Mapping Data:', mappingData);

            try {
                const response = await fetch('/base-code-mapper/start-mapping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mappingData)
                });

                const result = await response.json();
                console.log('Response:', result);
                if (result.status === 'success') {
                    $('#mapping-modal').modal('hide');
                    alert('Mapping process started successfully!');
                } else {
                    alert('Error starting mapping process: ' + result.message);
                }
            } catch (error) {
                console.error('Error starting mapping:', error);
                alert('Error starting mapping process');
            }
        });

        // Route table checkbox changes
        $('#route-table').on('change', '.route-checkbox', function() {
            updateMapButton();
            updateBeginMappingButton();
        });

        // Start polling logs
        pollLogs();
    });

    function updateMapButton() {
        const hasSelected = $('.route-checkbox:checked').length > 0;
        $('#map-button').prop('disabled', !hasSelected);
    }
</script>
{% endblock %}